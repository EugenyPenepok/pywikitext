$(document).ready(function() {
    function e(e) {
        return /^(GET|HEAD|OPTIONS|TRACE)$/.test(e)
    }
    var c = "";

    // Лочим кнопку подтверждения и выбор заголовков
    $(".test-select").prop("disabled", true);
    $("#btn-accept").prop("disabled", true);

    $("#btn-get-categories").on("click", function(e) {
        $("#get-categories-success").addClass('hide')
        $("#get-categories-error").addClass('hide')
        $("#get-categories-working").addClass('hide')

        $.getJSON("get_categories", function(e) {
            $("#get-categories-working").removeClass('hide')
            c = e, t = n()
        })
         .done(function() {
            $("#get-categories-success").removeClass('hide')
            $("#get-categories-error").addClass('hide')
             $("#get-categories-working").addClass('hide')
        })
        .fail(function() {
            $("#get-categories-success").addClass('hide')
            $("#get-categories-error").removeClass('hide')
            $("#get-categories-working").addClass('hide')
        });
        ;
        $("#btn-accept").prop("disabled", false);
    });
    var n = function() {
            return $("#treeview1").treeview({
                data: c,
                showIcon: !1,
                showCheckbox: !0,
                onNodeChecked: function(e, c) {
                    $("#checkable-output").prepend('<p> "' + c.text + '" выделена</p>')
                },
                onNodeUnchecked: function(e, c) {
                    $("#checkable-output").prepend('<p>"' + c.text + '" снято выделение</p>')
                }
            })
        },
        t = n(),
        i = function() {
            return t.treeview("search", [$("#input-check-node").val(), {
                ignoreCase: 1,
                exactMatch: !1
            }])
        },
        o = i();
    $("#input-check-node").on("keyup", function(e) {
        o = i(), $(".check-node").prop("disabled", !(o.length >= 1))
    }), $("#btn-check-node.check-node").on("click", function(e) {
        t.treeview("checkNode", [o, {
            silent: $("#chk-check-silent").is(":checked")
        }])
    }), $("#btn-uncheck-node.check-node").on("click", function(e) {
        t.treeview("uncheckNode", [o, {
            silent: $("#chk-check-silent").is(":checked")
        }])
    }), $("#btn-toggle-checked.check-node").on("click", function(e) {
        t.treeview("toggleNodeChecked", [o, {
            silent: $("#chk-check-silent").is(":checked")
        }])
    }), $("#btn-check-all").on("click", function(e) {
        t.treeview("checkAll", {
            silent: $("#chk-check-silent").is(":checked")
        })
    }), $("#btn-uncheck-all").on("click", function(e) {
        t.treeview("uncheckAll", {
            silent: $("#chk-check-silent").is(":checked")
        })
    });
    var k = jQuery("[name=csrfmiddlewaretoken]").val();
    $.ajaxSetup({
        beforeSend: function(c, n) {
            e(n.type) || this.crossDomain || c.setRequestHeader("X-CSRFToken", k)
        }
        }),
    $("#btn-accept").on("click", function(e) {
        for (var c = t.treeview("getChecked"), n = [], i = 0; i < c.length; i++) 
			n.push(c[i].href);

        $("#get-headers-success").addClass('hide')
        $("#get-headers-error").addClass('hide')

        $.ajax({
            type: "POST",
            url: "/post_tree_categories",
            data: {
                categories: JSON.stringify(n)
            }
        })
        .done(function() {
            $("#get-headers-success").removeClass('hide')
            $("#get-headers-error").addClass('hide')
        })
        .fail(function() {
            $("#get-headers-success").addClass('hide')
            $("#get-headers-error").removeClass('hide')
        });

        $(".test-select").prop("disabled", false);
    })
    // Модный, молодежный select
    // function formatState (state) {
    //   if (!state.id) { return state.text; }
    //   var $state = $(
    //       '<span class="badge">' state.element.amount '</span>'
    //     // '<span><img src="vendor/images/flags/' + state.element.value.toLowerCase() + '.png" class="img-flag" /> ' + state.text + '</span>'
    //   );
    //   return $state;
    // };

    $('.test-select').select2({
        multiple:true,
        templateSelection: function (data) {
            return data.text + ' - [' + data.amount + ']';
            // var $badge = $('<span class="badge">' + data.amount + '</span>');
            // return data.text + $badge;
        },
        templateResult: function (data) {
            return data.text + ' - [' + data.amount + ']';
        },
        ajax: {
        url: '/get_headers',
        dataType: 'json',
        delay: 300,
        processResults: function (headers) {
            return { results: headers };
        },

      }
    });

    $("#btn-accept-headers").on("click", function(e) {
        $("#post-headers-success").addClass('hide')
        $("#post-headers-error").addClass('hide')
        $.ajax({
            type: "POST",
            url: "/post_selected_headers",
            data: {
               headers: JSON.stringify($('.test-select').val())
            }
        })
        .done(function() {
            $("#post-headers-success").removeClass('hide')
            $("#post-headers-error").addClass('hide')
        })
        .fail(function() {
            $("#post-headers-success").addClass('hide')
            $("#post-headers-error").removeClass('hide')
        });

        $(".test-select").prop("disabled", false);
    })

});

